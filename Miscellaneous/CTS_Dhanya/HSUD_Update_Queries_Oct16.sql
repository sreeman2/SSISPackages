-- fetch blank voyages into a temp table
SELECT * FROM WORKTEMP.DBO.Voyages_Upd_Nov16 (NOLOCK)
where BILL_NUMBER = 'SUDU229990902006'
-- reference data from excel
SELECT * FROM WORKTEMP.DBO.HSUD_REF_SEP (NOLOCK)
where bill_nbr = 'SUDU229990902006'

-- fetch the hsud data to be updated matching bill number from ref data and blank voyage
SELECT DISTINCT UPD.BOL_ID,VYG.BILL_NBR,VYG.VOYAGE,CAST(SUBSTRING(VYG.VOYAGE,1,3) AS INT) AS VOYAGE_NBR
INTO WORKTEMP.DBO.Voyages_updated_Nov16
FROM WORKTEMP.DBO.Voyages_Upd_Nov16  UPD (NOLOCK) ,WORKTEMP.DBO.HSUD_REF_SEP VYG (NOLOCK) 
WHERE VYG.BILL_NBR =  UPD.BILL_NUMBER



SELECT * from WORKTEMP.DBO.Voyages_updated_Nov16 


where bill_nbr = 'SUDU229990902006' and voyage = 

select BILL_NBR,count(bol_id) from WORKTEMP.DBO.Voyages_updated_Nov16
group by BILL_NBR
having count(bol_id) >1 


'SUDU220010757005'
'SUDU220010811035'
'SUDU220010811077'
'SUDU220010897077'
'SUDU229990902006'


SELECT * FROM WORKTEMP.DBO.Voyages_updated_Nov16
WHERE BILL_NBR IN 
(
'SUDU220010757005',
'SUDU220010811035',
'SUDU220010811077',
'SUDU229990902006'
)

DELETE FROM WORKTEMP.DBO.Voyages_updated_Nov16 WHERE BOL_ID = 260124367 AND VOYAGE_NBR = 32
DELETE FROM WORKTEMP.DBO.Voyages_updated_Nov16 WHERE BILL_NBR = 'SUDU229990902006' AND VOYAGE_NBR = 64
DELETE FROM WORKTEMP.DBO.Voyages_updated_Nov16 WHERE BILL_NBR = 'SUDU220010811035' AND VOYAGE_NBR = 32
DELETE FROM WORKTEMP.DBO.Voyages_updated_Nov16 WHERE BILL_NBR = 'SUDU220010757005' AND VOYAGE_NBR = 59
 

--bills to be updated = 216
SELECT * FROM WORKTEMP.DBO.Voyages_updated_Nov16  (NOLOCK)

select top 100 voyage,* from pes_dw_bol (nolock)

BEGIN TRAN

-- 161 rows affected 
UPDATE DW SET DW.VOYAGE = UPD.VOYAGE_NBR,MODIFY_DATE = GETDATE(),MODIFY_BY = 'DATA_DEV'
--SELECT UPD.VOYAGE_NBR,dw.voyage,DW.*,UPD.VOYAGE_NBR
FROM PES_DW_BOL DW (NOLOCK),WORKTEMP.DBO.Voyages_updated_Nov16 UPD
WHERE DW.BOL_ID = UPD.BOL_ID
AND DW.BILL_NUMBER = UPD.BILL_NBR




-- 161 rows affected
UPDATE DWCMD SET DWCMD.MODIFY_DATE = GETDATE(),DWCMD.MODIFY_BY = 'DATA_DEV'
--SELECT DWCMD.*
FROM PES_DW_CMD DWCMD (NOLOCK),WORKTEMP.DBO.Voyages_updated_Nov16 UPD
WHERE DWCMD.BOL_ID = UPD.BOL_ID

COMMIT TRAN