SELECT * FROM PES_STG_BOL (NOLOCK)
WHERE BOL_NBR IN
(
'DLPDDL41104605',
'DLPDDL11104831',
'DLPDDL11104832',
'DLPDDL11104882',
'DLPDDL11104837',
'DLPDDL71104792',
'DLPDDL61104798',
'DLPDDL61104799',
'DLPDDL61104887',
'DLPDDL61104723',
'DLPDDL11104879',
'DLPDDL11104881',
'DLPDDL71104960',
'DLPDDL11104904',
'DLPDDL61104931',
'DLPD403021200219',
'DLPDDL11105201',
'DLPDDL11105210',
'DLPDDL31105230',
'DLPDDL41105028')

SELECT * FROM PES_STG_BOL (NOLOCK)
WHERE BOL_NBR IN
(
'EVCLBOT111135906',
'EVCLBOT111135908')




select * from archive_raw_bol (nolock)
WHERE BOL_NUMBER IN
(
'DLPDDL41104605',
'DLPDDL11104831',
'DLPDDL11104832',
'DLPDDL11104882',
'DLPDDL11104837',
'DLPDDL71104792',
'DLPDDL61104798',
'DLPDDL61104799',
'DLPDDL61104887',
'DLPDDL61104723',
'DLPDDL11104879',
'DLPDDL11104881',
'DLPDDL71104960',
'DLPDDL11104904',
'DLPDDL61104931',
'DLPD403021200219',
'DLPDDL11105201',
'DLPDDL11105210',
'DLPDDL31105230',
'DLPDDL41105028')

LKP_CARRIER_CODE = SUBSTRING(MASTER_BOL_DATA,42,4)

SELECT SUBSTRING('20111226HSAFM752614012',42,4)

-- REFERENCE TABLE

SELECT A.ID,A.CODE FROM REF_CARRIER A WHERE A.DELETED='N' AND A.IS_NVO='N' AND A.CODE IN(SELECT B.CODE FROM 
REF_CARRIER B WHERE B.DELETED='N' AND B.IS_NVO='N' GROUP BY B.CODE HAVING COUNT(*)=1)  
UNION
SELECT A.REF_ID,A.CODE_KEY FROM LIB_CARRIER A,REF_CARRIER B WHERE A.REF_ID=B.ID AND B.DELETED='N' AND B.IS_NVO='N' AND 
A.CODE_KEY IN(SELECT C.CODE_KEY FROM LIB_CARRIER C,REF_CARRIER D WHERE C.REF_ID=D.ID AND D.DELETED='N'
AND D.IS_NVO='N' GROUP BY C.CODE_KEY HAVING COUNT(C.CODE_KEY)=1)

-- MATCH ON ID AND LKP_CARRIER_CODE
-- O/P COLUMN = LKP_HOUSE_CARRIER_ID

select SUBSTRING(NVOSCAC_CODE,1,4) AS LKP_CARRIER_CODE 
from archive_raw_bol (nolock)
WHERE BOL_NUMBER IN
(
'DLPDDL41104605',
'DLPDDL11104831',
'DLPDDL11104832',
'DLPDDL11104882',
'DLPDDL11104837',
'DLPDDL71104792',
'DLPDDL61104798')

-- REF DATA
SELECT A.ID,A.CODE FROM REF_CARRIER A WHERE A.DELETED='N' AND A.IS_NVO='N' AND A.CODE IN(SELECT B.CODE FROM 
REF_CARRIER B WHERE B.DELETED='N' AND B.IS_NVO='N' GROUP BY B.CODE HAVING COUNT(*)=1)  
UNION
SELECT A.REF_ID,A.CODE_KEY FROM LIB_CARRIER A,REF_CARRIER B WHERE A.REF_ID=B.ID AND B.DELETED='N' AND B.IS_NVO='N' AND 
A.CODE_KEY IN(SELECT C.CODE_KEY FROM LIB_CARRIER C,REF_CARRIER D WHERE C.REF_ID=D.ID AND D.DELETED='N'
AND D.IS_NVO='N' GROUP BY C.CODE_KEY HAVING COUNT(C.CODE_KEY)=1)

-- MATCH AND PICK THE ID = 159


SELECT TOP 1000 * FROM PES_STG_BOL (NOLOCK) WHERE MST_BOL_TYPE = 'H'

select TOP 10 * from archive_raw_bol (nolock)
WHERE MASTER_BOL_dATA LIKE '%H%'

-- HOUSE BILL CONDITION CHECK
SELECT SUBSTRING(MASTER_BOL_DATA,41,1) AS HOUSEBILL_CHK
FROM ARCHIVE_RAW_BOL (NOLOCK)
WHERE BOL_NUMBER IN
( 
'DLPDDL41104605',
'DLPDDL11104831',
'DLPDDL11104832',
'DLPDDL11104882',
'DLPDDL11104837',
'DLPDDL71104792',
'DLPDDL61104798')

-- LKP_CARRIER_CODE
SELECT SUBSTRING(MASTER_BOL_DATA,42,4) 
FROM ARCHIVE_RAW_BOL (NOLOCK)
WHERE BOL_NUMBER IN
( 
'DLPDDL41104605',
'DLPDDL11104831',
'DLPDDL11104832',
'DLPDDL11104882',
'DLPDDL11104837',
'DLPDDL71104792',
'DLPDDL61104798')

-- INSERT THE NEW CARRIER CODE 'DLPD' INTO REF_CARRIER AND LIB_CARRIER
-- CHECK IF THE CARRIER CODE EXISTS IN REFERENCE DATA
-- REFERENCE DATA
SELECT A.ID,A.CODE FROM REF_CARRIER A WHERE A.DELETED='N' AND A.IS_NVO='N' AND A.CODE IN(SELECT B.CODE FROM 
REF_CARRIER B WHERE B.DELETED='N' AND B.IS_NVO='N' 
AND A.CODE ='SAFM'
GROUP BY B.CODE HAVING COUNT(*)=1) 
UNION
SELECT A.REF_ID,A.CODE_KEY FROM LIB_CARRIER A,REF_CARRIER B WHERE A.REF_ID=B.ID AND B.DELETED='N' AND B.IS_NVO='N' AND 
A.CODE_KEY IN(SELECT C.CODE_KEY FROM LIB_CARRIER C,REF_CARRIER D WHERE C.REF_ID=D.ID AND D.DELETED='N'
AND D.IS_NVO='N' 
AND A.CODE_KEY = 'SAFM'
GROUP BY C.CODE_KEY HAVING COUNT(C.CODE_KEY)=1)

-- VALID CARRIER

-- INVALID CARRIER
LKP_CARRIER_CODE

SELECT SUBSTRING(NVOSCAC_CODE,1,4) 
FROM ARCHIVE_RAW_BOL (NOLOCK)
WHERE BOL_NUMBER IN
( 
'DLPDDL41104605',
'DLPDDL11104831',
'DLPDDL11104832',
'DLPDDL11104882',
'DLPDDL11104837',
'DLPDDL71104792',
'DLPDDL61104798')

--REFERENCE DATA
SELECT A.ID,A.CODE FROM REF_CARRIER A WHERE A.DELETED='N' AND A.IS_NVO='N' AND A.CODE IN(SELECT B.CODE FROM 
REF_CARRIER B WHERE B.DELETED='N' AND B.IS_NVO='N' AND
A.CODE  = 'SAFM'
GROUP BY B.CODE HAVING COUNT(*)=1)  
UNION
SELECT A.REF_ID,A.CODE_KEY FROM LIB_CARRIER A,REF_CARRIER B WHERE A.REF_ID=B.ID AND B.DELETED='N' AND B.IS_NVO='N' AND 
A.CODE_KEY IN(SELECT C.CODE_KEY FROM LIB_CARRIER C,REF_CARRIER D WHERE C.REF_ID=D.ID AND D.DELETED='N'
AND D.IS_NVO='N' AND
A.CODE_KEY  = 'SAFM' 
GROUP BY C.CODE_KEY HAVING COUNT(C.CODE_KEY)=1)

-- IS VALID CARRIER (SAFM)

-- INVALID CARRIER
LKP_CARRIER_CODE

SELECT SUBSTRING(NVOSCAC_CODE,5,4)
FROM ARCHIVE_RAW_BOL (NOLOCK)
WHERE BOL_NUMBER IN
( 
'DLPDDL41104605',
'DLPDDL11104831',
'DLPDDL11104832',
'DLPDDL11104882',
'DLPDDL11104837',
'DLPDDL71104792',
'DLPDDL61104798')

-- REF DATA
SELECT A.ID,A.CODE FROM REF_CARRIER A WHERE A.DELETED='N' AND A.IS_NVO='N' AND A.CODE IN(SELECT B.CODE FROM 
REF_CARRIER B WHERE B.DELETED='N' AND B.IS_NVO='N' GROUP BY B.CODE HAVING COUNT(*)=1)  
UNION
SELECT A.REF_ID,A.CODE_KEY FROM LIB_CARRIER A,REF_CARRIER B WHERE A.REF_ID=B.ID AND B.DELETED='N' AND B.IS_NVO='N' AND 
A.CODE_KEY IN(SELECT C.CODE_KEY FROM LIB_CARRIER C,REF_CARRIER D WHERE C.REF_ID=D.ID AND D.DELETED='N'
AND D.IS_NVO='N' GROUP BY C.CODE_KEY HAVING COUNT(C.CODE_KEY)=1)

-- RE LOOK UP
SELECT * FROM REF_CARRIER WHERE DELETED='N' AND ID<>0 

